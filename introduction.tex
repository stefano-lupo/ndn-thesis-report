\chapter{Introduction}

\section{What is HubSpot?}
\textit{"HubSpot is inbound marketing and sales software that helps companies attract visitors, convert leads, and close customers."} \cite{whatIsHubSpot}\hfill\break

Over the past few decades, there has been a monumental shift in how consumers think about, shop for and purchase products. Consumers are now far more skeptical towards traditional marketing campaigns, for example via TV or print advertisements. Thanks to the near endless amount of information available on the internet, consumers are much more informed about the products or services they are purchasing and place their trust in credible third party reviews. In response to the modern consumer, a modern marketing strategy must be put in place. 

HubSpot is built with one core belief in mind - \textit{inbound marketing}. Inbound marketing is a strategy in which potential customers are \textit{attracted} to a website (or other establishment) naturally, prior to attempting to convert them into buying customers. The key concept here is that customers must be able to obtain something of value prior to making a purchase. This attracts potential customers to the website, provides them with something they need and gives them an insight into the quality of the product or service on offer. For example, a website of a company selling musical instruments may write a blog post detailing what one should look for when purchasing their first guitar. For a modern consumer looking to purchase a guitar for the first time, it is extremely likely that they will look online for some information and a comprehensive guide on what to look for when purchasing a guitar would be the perfect resource. While reading this article, the consumer could be provided with attractive CTAs (call-to-actions) which, for example, bring them to a list of suggested guitars for beginners. Thus, a potential customer has been naturally \textit{attracted} to the company's online store, after acquiring some knowledge on exactly what they are looking for. This is a stark contrast to the traditional approach to marketing in which the potential customer is simply shown an advertisement for a guitar. This overall concept of inbound marketing is succinctly summarized by the inbound marketing ethos - \textit{don't interrupt buyers, attract them} \cite{whatIsHubSpot}.

\section{The HubSpot Platform}
HubSpot offers a comprehensive suite of products to help businesses employ an inbound marketing strategy, all of which are contained within a single platform.

\subsection{Customer Relationship Management (CRM)}
At the core of the HubSpot platform, is the HubSpot CRM. Simply put, a CRM is a single data source consisting of \textbf{all} the data relating to a given customer. For example, it contains simple properties such as their name, age and address, but can also contain (in HubSpot's CRM) more complex information such as their last purchase, the last time they were contacted by a sales rep etc. Almost all of HubSpot's products aim to build \textit{personalized} experiences for their customers and the data required to drive these personalized experiences often comes from the CRM. As a CRM is such an integral part of a modern business' daily operations, HubSpot offers their CRM for free. 

\subsection{Sites}
HubSpot also provides a comprehensive website builder allowing users to build custom websites using a drag-and-drop style editor. This hugely simplifies the process of building a website, requiring zero knowledge of web development. These websites can be fully database driven, allowing the experience to be tailored to individual users. This product also includes a host of tools such as forms, CTAs, blogging and many others. All of the pages will be fully responsive and render perfectly on devices of any screen size. These sites can be hosted with HubSpot, further simplifying the website setup process.

\subsection{Email Marketing}
One of HubSpot's most popular tools is the marketing email product. Marketing emails can be built using an intuitive drag-and-drop editor and can be personalized on a per-subscriber basis, backed by HubSpot's CRM. Emails can be sent to arbitrarily complex subsets of subscribed customers (for example, customers who previously made a purchase, but haven't done so in 6 months). All marketing email that is sent can gather detailed analytics on how subscribers interact with the email, allowing HubSpot's customers to gain a deeper understanding of their customers. Similarly, email content can be optimized using A/B testing backed by machine learned models. A/B testing creates multiple versions of the same email, for example with different fonts and colours. A test send on a small sample of the target subscribers is performed, half of the sample receiving version A and half of the sample receiving version B. Key analytics such as open-rates and click rates are examined in order to attempt to ascertain which email will perform better on average. The better version of the email can then be sent to the remaining subscribers, maximizing the effectiveness of the marketing emails sent.

\subsection{Service Hub}
Modern customer's demand a high level of support should they encounter any issues when using a product or service. Service Hub is a modern tool to enable support staff to provide the high level of customer support that is necessitated today. This product provides a set of tools to enable customers to get in touch with \textit{who} they need to, \textit{when} they need to. It offers a plug and play messaging system for websites, allowing customers to chat with support staff in real time. It also offers a single tool for support staff which consolidates all customer conversations into one place (e.g. emails, support tickets, comments and even some social media support), allowing support staff to easily stay on top of their work. 


\section{The \team{} Team} \label{sec:emailSendingInfra}
The \team{} team is one six teams working on HubSpot's email products. These teams vary in purpose from creating the drag-and-drop email builder, gathering analytics on emails sent, ensuring that no spam email is sent through HubSpot and finally, the \team{} team's purpose, sending the actual final email. Considering the fact that sending email is quite an old and well established mechanism, at first glance, one might wonder why an entire team is needed solely for maintaining the infrastructure for sending the emails. However as HubSpot continues to grow, the number of emails that need to be sent continues to grow. Currently, HubSpot sends upwards of 60 - 70 million marketing emails per day on behalf of their customers. At this scale, sending email becomes a non-trivial task that must be carefully managed, requiring a high emphasis on efficiency at each step. 

There are some major challenges with sending email at this scale, primarily stemming from the fact that SMTP, the Secure Mail Transfer Protocol (see \refsec{sec:smtp}), was developed over 30 years ago. This protocol was designed with (relative to the modern day) very small packet sizes in mind. As such, it is a very \textit{chatty} protocol, requiring several round trips between client and server, which can cause the SMTP conversation required to send even a small email take time on the order of hundreds of milliseconds, or even seconds. Thus, sending millions of emails a day, each taking a (relatively) substantial amount of time, highlights the difficulties faced by the \team{} team. Another challenge of sending email is the variation in recipient servers. Anyone can very easily setup an email server on any machine. As one might expect, attempting to send 100 emails to a small desktop machine on a home network is very different to sending them a high performance mail server in one of Google's data centers. Thus, the \team{} team's systems must be able to handle sending to both types of servers efficiently. 

In today's computing world of multicore processors and high concurrency, the solution to the problem is to asynchronously send the emails, allowing the system to continue to perform useful work while waiting on responses from servers. However as with all concurrent solutions, this adds an extra layer of complexity to the system. System resources, especially the heap, where all of the in-flight emails will be stored, must be carefully managed. Another common issue faced is that recipient servers often apply heavy rate limiting to the IPs sending the emails, or to the SMTP domain from which the email originates. This is done to ensure the recipient servers are not overwhelmed by large spikes of emails from a single domain (a common occurrence when spammers compromise legitimate email accounts). Thus asynchronously sending emails requires distributed rate limiting through distributed semaphores, all of which must be carefully balanced in order to maximize throughput, while maintaining a good relationship with the recipient servers. 

The main project owned by the \team{} team is an internal Mail Transfer Agent (MTA). MTAs are systems responsible for sending email on behalf of clients. This internal MTA began development in 2016 and has been an integral part of HubSpot's email products ever since. The choice to develop an internal MTA may seem odd at first, given that email has been around for decades and many \textit{Mail Transfer Agents as a Service (MTAaaS)} already exist. There were several key reasons for developing an internal MTA. The first was to learn as much information about the email sending process as possible and to relay this information back to HubSpot email marketing customers, allowing them to create the best email marketing campaigns they can. Another key reason is that HubSpot is responsible for sending these marketing emails on behalf of their customers and cannot simply blame a third party should the MTAaaS perform poorly. Finally, it also provides flexibility and allows HubSpot's email products to grow and change overtime as the business dictates.  

The \team{} team is a relatively new team whose main focus is taking ownership of all the code used in HubSpot for the email sending process (including the internal MTA previously discussed). The team saw 25x growth in the number of emails sent through their MTA in 2017 and managed to become \textbf{more} reliable while scaling, enabling HubSpot's email products to grow without constraints.  